{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "0.9.0.0",
  "parameters": {
    "clusterName": {
      "type": "string",
      "metadata": {
        "description": "The name of the HDInsight cluster to create. No special symbols allowed in the name."
      }
    },
    "clusterUserName": {
      "type": "string",
      "metadata": {
        "description": "The user used to log into the HDInsight Portal and submit jobs."
      }
    },
    "clusterPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the HDInsight user."
      }
    },
    "clusterSSHUserName": {
      "type": "string",
      "metadata": {
        "description": "The user used to SSH into the cluster nodes."
      }
    },
    "clusterSSHPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the HDInsight SSH User."
      }
    }
  },
  "variables": {
    "clusterStorageAccountDeployment": "[concat('Microsoft.Storage/storageAccounts/', parameters('clusterName'))]",
    "clusterDefaultFS": "[concat('wasb://hdi@',parameters('clusterName'),'.blob.core.windows.net')]",
    "sqlServerName": "concat(parameters('clusterName'), 'sqlsrv'",
    "hiveMetastoreDatabaseName": "[concat(parameters('clusterName'), '_hive')]",
    "hiveMetastoreConnectionString": "[concat('jdbc:sqlserver://',parameters('clusterName'),'.database.windows.net;database=',variables('hiveMetastoreDatabaseName'),';encrypt=true;trustServerCertificate=true;create=flase;loginTimeout=300;')]"
  },
  "resources": [
      {
        "apiVersion": "2015-03-01-preview",
        "name": "[parameters('clusterName')]",
        "type": "Microsoft.HDInsight/clusters",
        "location": "eastus",
        "dependsOn": [
          "[variables('clusterStorageAccountDeployment')]",
          "concat('Microsoft.Storage/servers/databases/', variables('hiveMetastoreDatabaseName'))"
        ],
        "properties": {
          "clusterVersion": "3.4",
          "osType": "Linux",
          "tier": "premium",
          "clusterDefinition": {
            "kind": "spark",
            "configurations": {
              "gateway": {
                "restAuthCredential.isEnabled": true,
                "restAuthCredential.username": "[parameters('clusterUserName')]",
                "restAuthCredential.password": "[parameters('clusterPassword')]"
              },
              "core-site": {
                "fs.defaultFS": "[variables('clusterDefaultFS')]",
                "fs.azure.account.key.jfennessytraining.blob.core.windows.net": "[listKeys(variables('clusterStorageAccountDeployment'), '2015-05-01-preview').key1]"
              },
              "hive-site":{
                "javax.jdo.option.ConnectionDriverName": "com.microsoft.sqlserver.jdbc.SQLServerDriver",
                "javax.jdo.option.ConnectionURL": "variables('hiveMetastoreConnectionString')",
                "javax.jdo.option.ConnectionUserName": "parameters('clusterUserName')",
                "javax.jdo.option.ConnectionPassword": "parameters('clusterPassword')"     
              },
              "hive-env":{
                "hive_database": "Existing MSSQL Server database with SQL authentication",
                "hive_database_name": "variables('hiveMetastoreDatabaseName')",
                "hive_database_type": "mssql",
                "hive_existing_mssql_server_database": "variables('hiveMetastoreDatabaseName')",
                "hive_existing_mssql_server_host": "concat(variables('sqlServerName'),'.database.windows.net)",
                "hive_hostname": "concat(variables('sqlServerName'),'.database.windows.net)"
              }
            }
          },
          "computeProfile": {
            "roles": [
              {
                "name": "headnode",
                "minInstanceCount": 1,
                "targetInstanceCount": 2,
                "hardwareProfile": {
                  "vmSize": "Standard_D12_V2"
                },
                "osProfile": {
                  "linuxOperatingSystemProfile": {
                    "username": "[parameters('clusterSSHUserName')]",
                    "password": "[parameters('clusterSSHPassword')]"
                  }
                },
                "scriptActions": [
                  
                ]
              },
              {
                "name": "workernode",
                "minInstanceCount": 1,
                "targetInstanceCount": 2,
                "hardwareProfile": {
                  "vmSize": "Standard_D13_V2"
                },
                "osProfile": {
                  "linuxOperatingSystemProfile": {
                    "username": "[parameters('clusterSSHUserName')]",
                    "password": "[parameters('clusterSSHPassword')]"
                  }
                },
                "scriptActions": [
                  {
                    "name": "LoadNOAAWeatherData",
                    "uri": "https://raw.githubusercontent.com/joshuafennessy/hdinsightdemo/master/script_actions/download_weather_sample.sh",
                    "parameters": ""
                  }
                ]
              }
            ]
          }
        }
      },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[parameters('clusterName')]",
            "apiVersion": "2015-05-01-preview",
            "location": "East US",
            "properties": {
                "accountType": "Standard_LRS"
            }
        },
        {
          "type": "Microsoft.Sql/servers",
          "name": "variables('sqlServerName')",
          "apiVersion": "2014-04-01-preview",
          "location": "East US",
          "properties": {
                "administratorLogin": "parameters('clusterUserName')",
                "administratorLoginPassword": "parameters('clusterPassword')",
                "version": "12.0"
            }
        },
        {
          "type": "Microsoft.Sql/servers/databases",
          "kind": "v12.0,user",
          "name": "variables('hiveMetastoreDatabaseName')",
          "apiVersion": "2014-04-01-preview",
          "location": "East US",
          "properties": {
            "edition": "Basic",
            "status": "Online",
            "serviceLevelObjective": "Basic",
            "collation": "SQL_Latin1_General_CP1_CI_AS",
            "maxSizeBytes": "2147483648",
            "defaultSecondaryLocation": "East US 2",
            "elasticPoolName": null
          },
          "dependsOn": [
            "concat('Microsoft.Sql/servers/',variables('sqlServerName'))"
          ]

        },
        {
          "type": "Microsoft.Resources/deployments",
          "apiVersion": "2015-01-01",
          "name": "concat('RServerForHDInsight_',parameters('clusterName'))",
          "dependsOn": [
            "concat('Microsoft.HDInsight/clusters/',parameters('clusterName')"
          ],
          "properties": {
            "mode": "Incremental",
            "templateLink": {
              "uri": "https://gallery.azure.com/artifact/20150101/Microsoft.RServerForHDInsight.8.0.3/Artifacts/mainTemplate.json",
              "contentVersion": "1.0.0.0"
            },
            "parameters": {
              "clusterName": {
                "value": "[parameters('clusterName')]"
              },
              "galleryPackageIdentity": {
                "value": "Microsoft.RServerForHDInsight.8.0.3"
              },
              "edgeNodeSize": {
                "value": "Standard_D4_v2"
              }
            }
          }
        }
    ]
}