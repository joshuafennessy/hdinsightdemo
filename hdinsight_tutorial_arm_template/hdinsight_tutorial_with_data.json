{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "0.9.0.0",
  "parameters": {
    "clusterName": {
      "type": "string",
      "metadata": {
        "description": "The name of the HDInsight cluster to create. No special symbols allowed in the name."
      }
    },
    "clusterUserName": {
      "type": "string",
      "metadata": {
        "description": "The user used to log into the HDInsight Portal and submit jobs."
      }
    },
    "clusterPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the HDInsight user."
      }
    },
    "clusterSSHUserName": {
      "type": "string",
      "metadata": {
        "description": "The user used to SSH into the cluster nodes."
      }
    },
    "clusterSSHPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the HDInsight SSH User."
      }
    }
  },
  "variables": {
    "clusterStorageAccountDeployment": "[concat('Microsoft.Storage/storageAccounts/', parameters('clusterName'))]",
    "clusterDefaultFS": "[concat('wasb://hdi@',parameters('clusterName'),'.blob.core.windows.net')]",
    "sqlServerName": "[parameters('clusterName')]",
    "hiveMetastoreDatabaseName": "hivemetastore",
    "hiveMetastoreConnectionString": "[concat('jdbc:sqlserver://',parameters('clusterName'),'.database.windows.net;database=',variables('hiveMetastoreDatabaseName'),';encrypt=true;trustServerCertificate=true;create=flase;loginTimeout=300;')]"
  },
  "resources": [
      {
        "apiVersion": "2015-03-01-preview",
        "name": "[parameters('clusterName')]",
        "type": "Microsoft.HDInsight/clusters",
        "location": "eastus",
        "dependsOn": [
          "[variables('clusterStorageAccountDeployment')]",
          "[concat('Microsoft.Sql/servers/', variables('sqlServerName'))]"
        ],
        "properties": {
          "clusterVersion": "3.4",
          "osType": "Linux",
          "tier": "premium",
          "clusterDefinition": {
            "kind": "spark",
            "configurations": {
              "gateway": {
                "restAuthCredential.isEnabled": true,
                "restAuthCredential.username": "[parameters('clusterUserName')]",
                "restAuthCredential.password": "[parameters('clusterPassword')]"
              },
              "core-site": {
                "fs.defaultFS": "[variables('clusterDefaultFS')]",
                "fs.azure.account.key.jfennessytraining.blob.core.windows.net": "[listKeys(variables('clusterStorageAccountDeployment'), '2015-05-01-preview').key1]"
              }
            }
          },
          "computeProfile": {
            "roles": [
              {
                "name": "headnode",
                "minInstanceCount": 1,
                "targetInstanceCount": 2,
                "hardwareProfile": {
                  "vmSize": "Standard_D12_V2"
                },
                "osProfile": {
                  "linuxOperatingSystemProfile": {
                    "username": "[parameters('clusterSSHUserName')]",
                    "password": "[parameters('clusterSSHPassword')]"
                  }
                },
                "scriptActions": [
                  
                ]
              },
              {
                "name": "workernode",
                "minInstanceCount": 1,
                "targetInstanceCount": 2,
                "hardwareProfile": {
                  "vmSize": "Standard_D13_V2"
                },
                "osProfile": {
                  "linuxOperatingSystemProfile": {
                    "username": "[parameters('clusterSSHUserName')]",
                    "password": "[parameters('clusterSSHPassword')]"
                  }
                },
                "scriptActions": [
                  {
                    "name": "LoadNOAAWeatherData",
                    "uri": "https://raw.githubusercontent.com/joshuafennessy/hdinsightdemo/master/script_actions/download_weather_sample.sh",
                    "parameters": ""
                  }
                ]
              }
            ]
          }
        }
      },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[parameters('clusterName')]",
            "apiVersion": "2015-05-01-preview",
            "location": "East US",
            "properties": {
                "accountType": "Standard_LRS"
            }
        },
    {
      "type": "Microsoft.Sql/servers",
      "name": "jfennessytraining",
      "apiVersion": "2014-04-01-preview",
      "location": "East US",
      "properties": {
        "administratorLogin": "[parameters('clusterUserName')]",
        "administratorLoginPassword": "[parameters('clusterPassword')]",
        "version": "12.0"
      },
      "resources": [
        {
          "name": "weather",
          "type": "databases",
          "location": "[resourceGroup().location]",
          "tags": {
            "displayName": "Weather Database"
          },
          "apiVersion": "2014-04-01-preview",
          "dependsOn": [
            "[variables('sqlserverName')]"
          ],
          "properties": {
            "edition": "Basic",
            "collation": "SQL_Latin1_General_Cp1_CI_AI_KI_WI",
            "maxSizeBytes": "2147483648",
            "requestedServiceObjectiveName": "S0"
          }
        },
        {
          "type": "firewallrules",
          "apiVersion": "2014-04-01-preview",
          "dependsOn": [
            "[variables('sqlserverName')]"
          ],
          "location": "[resourceGroup().location]",
          "name": "AllowAllWindowsAzureIps",
          "properties": {
            "endIpAddress": "0.0.0.0",
            "startIpAddress": "0.0.0.0"
          }
        }
      ]
    }
    ]
}